name: Deploy e2e-test (Final)

on:
  workflow_dispatch:
    inputs:
      target_env:
        description: "Select target server (26 / 27 / 28)"
        required: true
        type: choice
        options:
          - "26"
          - "27"
          - "28"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) 서버 번호에 따라 secrets 매핑
      - name: Map server info
        id: map
        run: |
          case "${{ github.event.inputs.target_env }}" in
            "26")
              echo "HOST=${{ secrets.SERVER_26_HOST }}" >> $GITHUB_OUTPUT
              echo "PORT=${{ secrets.SERVER_26_PORT }}" >> $GITHUB_OUTPUT
              echo "USER=${{ secrets.SERVER_26_USER }}" >> $GITHUB_OUTPUT
              echo "KEY=${{ secrets.SERVER_26_KEY }}" >> $GITHUB_OUTPUT
              ;;
            "27")
              echo "HOST=${{ secrets.SERVER_27_HOST }}" >> $GITHUB_OUTPUT
              echo "PORT=${{ secrets.SERVER_27_PORT }}" >> $GITHUB_OUTPUT
              echo "USER=${{ secrets.SERVER_27_USER }}" >> $GITHUB_OUTPUT
              echo "KEY=${{ secrets.SERVER_27_KEY }}" >> $GITHUB_OUTPUT
              ;;
            "28")
              echo "HOST=${{ secrets.SERVER_28_HOST }}" >> $GITHUB_OUTPUT
              echo "PORT=${{ secrets.SERVER_28_PORT }}" >> $GITHUB_OUTPUT
              echo "USER=${{ secrets.SERVER_28_USER }}" >> $GITHUB_OUTPUT
              echo "KEY=${{ secrets.SERVER_28_KEY }}" >> $GITHUB_OUTPUT
              ;;
          esac

      # 2) 템플릿 호출
      - name: Call deploy template
        uses: SYSTRAN-KOREA-AI/.github/.github/workflows/deploy-spring-template.yml@main
        with:
          service_name: e2e-test
          target_host: ${{ steps.map.outputs.HOST }}
          target_port: ${{ steps.map.outputs.PORT }}
          target_user: ${{ steps.map.outputs.USER }}
        secrets:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          TARGET_KEY: ${{ steps.map.outputs.KEY }}
